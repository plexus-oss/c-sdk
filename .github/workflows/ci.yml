name: CI

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]

jobs:
  host-tests:
    name: Host Tests (ASan + UBSan)
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Build tests
        run: |
          cmake -B build-test tests/
          cmake --build build-test/

      - name: Run tests
        run: ctest --test-dir build-test --output-on-failure

  host-tests-minimal:
    name: Host Tests (Minimal Config)
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Build tests (minimal config ~1.5KB)
        run: |
          cmake -B build-test-min tests/ -DPLEXUS_MINIMAL_CONFIG=ON
          cmake --build build-test-min/

      - name: Run tests (minimal)
        run: ctest --test-dir build-test-min --output-on-failure

  pio-esp32-arduino:
    name: PlatformIO ESP32 (Arduino)
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Cache PlatformIO
        uses: actions/cache@v4
        with:
          path: ~/.platformio
          key: pio-esp32-${{ hashFiles('platformio.ini') }}
          restore-keys: pio-esp32-

      - name: Install PlatformIO
        run: pip install platformio

      - name: Build ESP32 Arduino
        run: |
          pio ci examples/arduino_basic/plexus_example.ino \
            --lib=. \
            --board=esp32dev \
            --project-option="framework=arduino"

  pio-esp8266:
    name: PlatformIO ESP8266 (Arduino)
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Cache PlatformIO
        uses: actions/cache@v4
        with:
          path: ~/.platformio
          key: pio-esp8266-${{ hashFiles('platformio.ini') }}
          restore-keys: pio-esp8266-

      - name: Install PlatformIO
        run: pip install platformio

      - name: Build ESP8266 Arduino
        run: |
          pio ci examples/arduino_basic/plexus_example.ino \
            --lib=. \
            --board=nodemcuv2 \
            --project-option="framework=arduino"

  pio-stm32:
    name: PlatformIO STM32
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Cache PlatformIO
        uses: actions/cache@v4
        with:
          path: ~/.platformio
          key: pio-stm32-${{ hashFiles('platformio.ini') }}
          restore-keys: pio-stm32-

      - name: Install PlatformIO
        run: pip install platformio

      - name: Build STM32
        run: |
          pio ci \
            examples/stm32_freertos/main.c \
            src/plexus.c \
            src/plexus_json.c \
            src/plexus_commands.c \
            --board=nucleo_f446re \
            --project-option="framework=stm32cube" \
            --project-option="build_flags=-DSTM32F4 -DSTM32_HAL -Iinclude -Isrc"
