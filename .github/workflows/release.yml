name: Release

on:
  release:
    types: [published]

jobs:
  validate:
    name: Validate release
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Check tag matches code version
        run: |
          TAG="${GITHUB_REF#refs/tags/v}"
          CODE_VERSION=$(grep -oP 'PLEXUS_SDK_VERSION\s+"\K[^"]+' src/plexus.h)
          echo "Git tag version: $TAG"
          echo "Code version:    $CODE_VERSION"
          if [ "$TAG" != "$CODE_VERSION" ]; then
            echo "::error::Tag v$TAG does not match PLEXUS_SDK_VERSION ($CODE_VERSION)"
            exit 1
          fi

      - name: Build tests
        run: |
          cmake -B build-test tests/
          cmake --build build-test/

      - name: Run tests
        run: ctest --test-dir build-test --output-on-failure
